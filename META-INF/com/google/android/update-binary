#!/bin/sh
#BY ZhuiMeng

set -e
ZIP=$3
OUTFD=/proc/self/fd/$2;
ui_print() { echo -e "ui_print $1\nui_print" > $OUTFD; }
package_extract_file(){ unzip -p "$ZIP" $1 > $2;}
if [ -d /tmp/tool ];then rm -r /tmp/tool ; fi
mkdir -p /tmp/tool

unzip "$ZIP" META-INF/zstd -d /tmp/tool
chmod -R 0777 /tmp/tool
export PATH=/tmp/tool/META-INF:$PATH

keyListener() {
    ui_print "===按下 [音量+] 选择 是，按下 [音量-] 选择 否"
    ui_print ""
    keyListener_2
}

keyListener_2() {
    getevent -qlc 1 2>&1 | grep VOLUME | grep " DOWN" >/tmp/events
    if $(grep -q "VOLUMEUP" /tmp/events); then
        ui_print " - 正在执行中，请稍后......"
        return 0
    elif $(grep -q "VOLUMEDOWN" /tmp/events); then
        ui_print " - 正在执行中，请稍后......"
        return 1
    else
        keyListener_2
    fi
}

ui_print " "
ui_print "╔═════════════════════════"
ui_print "║  Origin OS 3.1 for Redmi K60 "
ui_print "║  机型 ：RedmiK60"
ui_print "║  代号 ：mondrian"
ui_print "║  脚本制作  ：酷安@行啊您"
ui_print "║  rom打包 ：行啊您"
ui_print "║  交流群：657066407"
ui_print "╚═════════════════════════"
ui_print " "
ui_print "===是否需要安装 Magisk Delta(Root)"
ui_print " "
if keyListener; then
    ui_print " "
    ui_print "===正在刷入新系统内核"
    package_extract_file "images/boot.img" "/dev/block/bootdevice/by-name/boot"
    ui_print " "
    ui_print "===已完成安装 Magisk Delta(Root)"
    ui_print "===首次开机后若桌面没有显示德尔塔面具apk图标，请群公告自行下载安装"
    ui_print " "
    ui_print "===是否禁用全部Magisk模块，防止模块不兼容导致无法开机"
	ui_print " "
    if keyListener; then
        for MODULES in $(ls -d /data/adb/modules/*); do
            touch $MODULES/disable
        done
	    ui_print " "
        ui_print "===已完成禁用全部Magisk模块"
        ui_print " "
    else
	    ui_print " "
        ui_print "===已取消禁用全部Magisk模块"
		ui_print " "
    fi
else
    ui_print " "
    ui_print "===正在刷入新系统内核"
    package_extract_file "images/miboot.img" "/dev/block/bootdevice/by-name/boot"
	ui_print " "
    ui_print "===已取消安装 Magisk Delta(Root)"
	ui_print "开机后rom将没有root权限功能"
fi
ui_print " "
ui_print "===����д����ϵͳ�ײ�"
package_extract_file "images/abl.img" "/dev/block/bootdevice/by-name/abl"
package_extract_file "images/aop.img" "/dev/block/bootdevice/by-name/aop"
package_extract_file "images/bluetooth.img" "/dev/block/bootdevice/by-name/bluetooth"
package_extract_file "images/aop_config.img" "/dev/block/bootdevice/by-name/aop_config"
package_extract_file "images/imagefv.img" "/dev/block/bootdevice/by-name/imagefv"
package_extract_file "images/recovery.img" "/dev/block/bootdevice/by-name/recovery"
package_extract_file "images/uefi.img" "/dev/block/bootdevice/by-name/uefi"
package_extract_file "images/xbl_ramdump.img" "/dev/block/bootdevice/by-name/xbl_ramdump"
package_extract_file "images/devcfg.img" "/dev/block/bootdevice/by-name/devcfg"
package_extract_file "images/dsp.img" "/dev/block/bootdevice/by-name/dsp"
package_extract_file "images/featenabler.img" "/dev/block/bootdevice/by-name/featenabler"
package_extract_file "images/hyp.img" "/dev/block/bootdevice/by-name/hyp"
package_extract_file "images/keymaster.img" "/dev/block/bootdevice/by-name/keymaster"
package_extract_file "images/modem.img" "/dev/block/bootdevice/by-name/modem"
package_extract_file "images/qupfw.img" "/dev/block/bootdevice/by-name/qupfw"
package_extract_file "images/tz.img" "/dev/block/bootdevice/by-name/tz"
package_extract_file "images/uefisecapp.img" "/dev/block/bootdevice/by-name/uefisecapp"
package_extract_file "images/xbl.img" "/dev/block/bootdevice/by-name/xbl"
package_extract_file "images/xbl_config.img" "/dev/block/bootdevice/by-name/xbl_config"
package_extract_file "images/vm-bootsys.img" "/dev/block/bootdevice/by-name/vm-bootsys"
package_extract_file "images/cpucp.img" "/dev/block/bootdevice/by-name/cpucp"
package_extract_file "images/shrm.img" "/dev/block/bootdevice/by-name/shrm"
package_extract_file "images/vendor_boot.img" "/dev/block/bootdevice/by-name/vendor_boot"
package_extract_file "images/dtbo.img" "/dev/block/bootdevice/by-name/dtbo"
package_extract_file "images/recovery.img" "/dev/block/bootdevice/by-name/recovery.img"

ui_print "===正在关闭VB2.0验证"
package_extract_file "images/vbmeta.img" "/dev/block/bootdevice/by-name/vbmeta"
ui_print ""
package_extract_file "images/vbmeta_system.img" "/dev/block/bootdevice/by-name/vbmeta_system"
ui_print "===正在删除官方cust分区推广"
package_extract_file "images/cust.img" "/dev/block/bootdevice/by-name/cust"

ui_print "===正在写入新系统"
unzip -p "$ZIP" images/super.zst.img | zstd -c -d > /dev/block/bootdevice/by-name/super
ui_print "===刷机完成"
ui_print "╔═════════════════════════"
ui_print "║  Origin OS 3.1 for Redmi K60 "
ui_print "║  机型 ：RedmiK60"
ui_print "║  代号 ：mondrian"
ui_print "║  脚本制作  ：酷安@行啊您"
ui_print "║  rom打包 ：行啊您"
ui_print "║  交流群：657066407"
ui_print "╚═════════════════════════"
ui_print " "
ui_print "===二合一刷机包卡刷只需几十秒时间，安装成功即为刷机成功"
ui_print "===请无视刷机完成后挂载分区失败红字提示"
ui_print "===请无视重启手机时没有安装任何系统提示"
ui_print "===请无视重启手机时没有安装任何系统提示"
ui_print " ------已内置TWRP无需再次安装！！！！！"
ui_print " "
exit 0
